
default:
  image: ubuntu:22.04

stages:          # List of stages for jobs, and their order of execution
  - build
  - test
  - coverage

variables:
  GIT_STRATEGY: fetch

before_script:
  - DEBIAN_FRONTEND=noninteractive apt -y update
  - DEBIAN_FRONTEND=noninteractive apt -y install build-essential gcovr libcriterion3 libcriterion-dev

#--------------------------#
#          BUILD           #
#--------------------------#

build-job:       # This job runs in the build stage, which runs first.
  stage: build
  rules:
    - if: $CI_DEFAULT_BRANCH == $CI_DEFAULT_BRANCH # True, just here to show possibilities
      variables:
        COVERAGE: 1
  script:
    - echo "Compiling the code..."
    # Build the library and generate coverage info at the same time
    - make library # Build library
    - make check
  artifacts:
    paths:
      - ./check         # Testsuite binary
      - ./libfnmatch.a  # Actual library
      - src/*.gcno      # Generated files for coverage

#--------------------------#
#          TESTS           #
#--------------------------#

testsuite-job:
  stage: test
  dependencies:
    - build-job
  script:
    - ./check
  artifacts:
    paths:
      - src/*.gcda    # Files containing coverage data
      - src/*.gcno    # Files containing coverage data

#--------------------------#
#         COVERAGE         #
#--------------------------#

coverage-cobertura-job:
  stage: coverage
  dependencies:
    - testsuite-job
  script:
    - ./scripts/make_report.sh
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
  artifacts:
    when: on_success
    paths:
      - coverage/*.html
      - coverage/*.css
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/coverage.xml
